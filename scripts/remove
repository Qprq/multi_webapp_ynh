#!/bin/bash

source .fonctions	# Charge les fonctions génériques habituellement utilisées dans le script

# Récupère les infos de l'application.
YNH_VERSION	# Récupère le numéro de version de Yunohost.
if [ $ynh_version = "2.4" ]; then
	app=$YNH_APP_INSTANCE_NAME

	# Source app helpers
	source /usr/share/yunohost/helpers
else
	app=multi_webapp
	MYSQL_ROOT_PWD_FILE="/etc/yunohost/mysql"
fi
admin=$(sudo yunohost app setting $app ftp_user)
path=$(sudo yunohost app setting $app path)
domain=$(sudo yunohost app setting $app domain)
appname=$(sudo yunohost app setting $app appname)
sql=$(sudo yunohost app setting $app sql)
final_path=$(sudo yunohost app setting $app final_path)
parent_dir=/var/www/webapp_$admin

# Suppression de la base de données.
# Utilise '$app' comme nom d'utilisateur et de base de donnée
db_user=$app
if [ -n "$db_user" ]
then
	REMOVE_BDD $db_user	# Suppression de la base de donnée et de l'utilisateur associé.
fi

SECURE_REMOVE '$final_path'	# Suppression du dossier de la webapp

app=$appname	# Utilise appname pour FPM et nginx
REMOVE_NGINX_CONF	# Suppression de la configuration nginx

# Vérifie si le dossier parent est vide. Ce qui signifie que toutes les webapp ont été désinstallées. Ainsi que le client ftp net2ftp.
if [ -e "$parent_dir" ]
then
	if test -z "$(ls $parent_dir | head -n1)"
	then
		sudo rmdir $parent_dir
	fi
fi

REMOVE_FPM_CONF	# Suppression de la configuration du pool php-fpm

# Régénère la configuration de SSOwat
sudo yunohost app ssowatconf

echo -e "\e[0m"	# Restore normal color
